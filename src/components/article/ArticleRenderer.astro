---
// src/components/article/ArticleRenderer.astro
import { Image } from "astro:assets";
import type { ContentBlock } from '../../types/article';

interface Props {
  blocks: ContentBlock[];
}

const { blocks } = Astro.props;
---

<div class="article-content max-w-4xl mx-auto px-5 md:px-8">
  {blocks.map((block) => {
    switch (block.type) {
      case 'heading': {
        const Level = `h${block.level}` as any;
        const sizeClass = {
          1: 'text-3xl md:text-4xl mt-12 mb-6',
          2: 'text-2xl md:text-3xl mt-10 mb-5',
          3: 'text-xl md:text-2xl mt-8 mb-4',
          4: 'text-lg md:text-xl mt-6 mb-3'
        }[block.level] || 'text-xl';
        
        return (
          <Level class={`font-bold text-white ${sizeClass}`}>
            {block.content}
          </Level>
        );
      }

      case 'text':
        return (
          <div class={`prose-text text-gray-300 text-lg md:text-xl my-8 md:my-10 leading-relaxed tracking-wide ${block.align === 'center' ? 'text-center' : ''} ${block.align === 'right' ? 'text-right' : ''}`}>
            <Fragment set:html={block.content} />
          </div>
        );

      case 'image':
        if (block.layout === 'portrait') {
          return (
            <figure class="my-16 md:my-24 flex flex-col items-center">
              <div class="relative max-w-md w-full p-2 md:p-4 bg-white/5 border border-white/5 rounded-2xl shadow-2xl rotate-1 hover:rotate-0 transition-transform duration-500 group">
                <Image 
                  src={block.src} 
                  alt={block.caption || ''}
                  inferSize={true}
                  class="w-full h-auto rounded-xl"
                />
                 {block.exif && (
                  <div class="absolute bottom-6 right-6 text-[10px] font-mono text-white/80 bg-black/40 backdrop-blur-sm px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                    {block.exif}
                  </div>
                )}
              </div>
               {block.caption && (
                 <figcaption class="mt-6 text-sm text-gray-500 italic">
                    — {block.caption}
                  </figcaption>
               )}
            </figure>
          );
        }
        
        // Default layout (Full width inside container)
        return (
          <figure class={`my-16 md:my-24 group relative ${block.layout === 'bleed' ? '-mx-5 md:-mx-20' : ''}`}>
            <div class={`overflow-hidden ${block.layout === 'bleed' ? 'rounded-none md:rounded-2xl' : 'rounded-xl'} shadow-2xl`}>
              <Image 
                src={block.src} 
                alt={block.caption || ''}
                inferSize={true}
                class="w-full h-auto object-cover transition-transform duration-700 group-hover:scale-[1.02]"
              />
            </div>
            <div class={`mt-4 flex flex-col md:flex-row md:items-center justify-between gap-2 ${block.layout === 'bleed' ? 'px-5 md:px-0' : ''}`}>
              {block.caption && (
                <figcaption class="text-sm text-gray-400 italic border-l-2 border-emerald-500 pl-3">
                  {block.caption}
                </figcaption>
              )}
              {block.exif && (
                <div class="text-xs font-mono text-gray-500 bg-white/5 px-3 py-1 rounded-full border border-white/5 w-fit">
                  {block.exif}
                </div>
              )}
            </div>
          </figure>
        );

      case 'gallery':
        const gridCols = block.layout === 'grid-3' ? 'md:grid-cols-3' : 'md:grid-cols-2';
        return (
          <div class="my-16 md:my-24">
            <div class={`grid grid-cols-1 ${gridCols} gap-4 md:gap-8`}>
              {block.images.map((img, idx) => (
                <div class={`relative group overflow-hidden rounded-2xl shadow-lg ${
                  // 简单的错落效果逻辑
                  block.layout === 'grid-2' && idx % 2 === 1 ? 'md:mt-12' : 
                  block.layout === 'grid-2' && idx % 2 === 0 ? 'md:mb-12' : ''
                }`}>
                  <Image 
                    src={img.src} 
                    alt={block.caption || ''}
                    inferSize={true}
                    class="w-full h-80 md:h-[500px] object-cover transition-transform duration-700 group-hover:scale-105"
                  />
                  {img.exif && (
                    <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/80 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-end">
                      <span class="text-[10px] font-mono text-white/90 border border-white/20 px-2 py-0.5 rounded-md bg-black/30 backdrop-blur-md">
                        {img.exif}
                      </span>
                    </div>
                  )}
                </div>
              ))}
            </div>
            {block.caption && (
              <div class="text-center mt-8 text-sm text-gray-500 italic">
                {block.caption}
              </div>
            )}
          </div>
        );

      case 'quote':
        return (
          <blockquote class="my-12 pl-6 border-l-4 border-emerald-500/50 italic text-xl md:text-2xl text-gray-400 font-serif leading-relaxed">
            "{block.content}"
            {block.author && <footer class="mt-2 text-base text-emerald-500/80 not-italic font-sans">— {block.author}</footer>}
          </blockquote>
        );
      
      case 'divider':
        return <div class="my-16 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent" />;

      default:
        return null;
    }
  })}
</div>
