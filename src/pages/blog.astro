---
import StickyNav from "../components/sticky_nav.astro";
import CategoryIcon from "../components/category_icon.astro";
import ArticlesListBlog from "../components/articles_list_blog.astro";
import timeline from "../data/blog_timeline";
import type { TimelineGroup, TimelineItem } from "../data/blog_timeline";
import { categories } from "../data/blog_category";
import { hotTags } from "../data/blog_category";
import type { BlogCategory } from "../data/blog_category";
const blogTimeline: TimelineGroup[] = timeline;
const timelineCount = blogTimeline.reduce((sum, g) => sum + g.items.length, 0);

// Flatten timeline for client-side filtering
const allBlogPosts = blogTimeline.flatMap((group) =>
  group.items.map((item) => ({
    ...item,
    // Use full date for sorting and display in list view
    time: `${group.year}-${item.time}`,
    // Keep original short time if needed, but list view usually prefers full date
    // Or we can keep 'time' as is and add 'fullTime', but let's standardize on 'time' for the list view
    // actually, let's keep 'time' as the display string (YYYY-MM-DD)
    year: group.year,
    tags: item.tags || []
  }))
);

const currentYear = new Date().getFullYear();

// 解析时间线条目的日期：支持完整日期、以及不含年份的 MM-DD 等格式
function parseTimelineDate(t: string | undefined, year: number): Date | null {
  const s = String(t || '').trim();
  if (!s) return null;
  // 尝试直接解析
  const d1 = new Date(year + '-' + s);
  if (!isNaN(d1.getTime())) return d1;
  // 标准化分隔符
  const norm = s.replace(/[./]/g, '-');
  // 处理 MM-DD / M-D
  const mmdd = norm.match(/^\d{1,2}-\d{1,2}$/);
  if (mmdd) {
    const [m, d] = norm.split('-');
    const mm = m.padStart(2, '0');
    const dd = d.padStart(2, '0');
    const composed = `${year}-${mm}-${dd}`;
    const d2 = new Date(composed);
    if (!isNaN(d2.getTime())) return d2;
  }
  // 兜底：提取连续数字尝试 YYYYMMDD
  const digits = norm.replace(/[^0-9]/g, '');
  if (digits.length >= 8) {
    const y = digits.slice(0, 4);
    const m = digits.slice(4, 6);
    const d = digits.slice(6, 8);
    const composed = `${y}-${m}-${d}`;
    const d3 = new Date(composed);
    if (!isNaN(d3.getTime())) return d3;
  }
  return null;
}

// 判断日期是否在最近 N 个月内（通过给条目日期 +N 个月与当前时间比较，避免不同月长度误差）
function isWithinLastMonths(dt: Date, months: number): boolean {
  const end = new Date(dt.getTime());
  end.setMonth(end.getMonth() + months);
  end.setHours(23, 59, 59, 999);
  const now = new Date();
  return end >= now;
}

// 为浏览器 window 增加类型声明，提供 __categoryArticles__ 挂载点
declare global {
  interface Window {
    __allBlogPosts__: TimelineItem[];
  }
}

// 使用 CategoryIcon 组件渲染 SVG 图标（不使用 emoji）
---

<!doctype html>
<html lang="zh-CN" data-theme="black">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Devin's Nest</title>
    <meta name="description" content="记录技术/生活/旅行/摄影等博客文章" />
    <link
      rel="preload"
      href="/fonts/MaoKenZhuYuanTi.ttf"
      as="font"
      type="font/ttf"
      crossorigin
    />
    <link rel="shortcut icon" href="/favicons/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicons/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicons/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicons/favicon-16x16.png"
    />
    <link rel="manifest" href="/favicons/site.webmanifest" />
    <style>
      @font-face {
        font-family: "MaokenZhuyuanTi";
        src: url(/fonts/MaoKenZhuYuanTi.ttf);
        font-display: swap;
      }
      body {
        cursor: url(/icons/cursor.ico), auto;
        font-family: "MaokenZhuyuanTi";
      }
      /* 时间线：左侧竖线与节点样式 */
      .timeline {
        position: relative;
        padding-left: 1.25rem; /* 20px */
        border-left: 2px solid rgba(255,255,255,0.08);
      }
      /* 今年：左侧竖线绿色 */
      .timeline-current {
        border-left-color: rgb(16 185 129); /* emerald-500 */
      }
      .timeline-item {
        position: relative;
        padding-left: 1rem; /* 16px */
        margin-bottom: 0.75rem; /* 12px */
      }
      .timeline-item::before {
        content: "";
        position: absolute;
        left: -0.39rem;
        top: 0.5rem;
        width: 0.5rem;
        height: 0.5rem;
        border-radius: 9999px;
        /* 默认：灰色表示过去 */
        background-color: rgb(156 163 175); /* gray-400 */
        box-shadow: 0 0 0 3px rgba(156,163,175,0.25);
      }
      /* 当前年份：绿色点表示现在 */
      .timeline-item.is-current-year::before {
        background-color: rgb(16 185 129); /* emerald-500 */
        box-shadow: 0 0 0 3px rgba(16,185,129,0.25);
      }
    </style>
  </head>
  <body class="bg-base-100">
    <StickyNav showImmediately={true} />

    <main class="max-w-screen-2xl pt-20 mx-auto px-3 xs:px-5 lg:px-10 py-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 左侧：时间线列表 -->
        <section class="lg:col-span-2">
          <div id="timeline-view" class="card rounded-2xl shadow-xl bg-white/5 backdrop-blur-md border border-white/5">
            <div class="card-body">
              <h1 class="text-2xl md:text-3xl font-bold mb-2">博客时间线</h1>
              <p class="text-gray-400 mb-4">记录那些让人心动的瞬间与思考</p>

              {blogTimeline.map((group: TimelineGroup) => (
                <div class="mb-6" data-year-group>
                  <h2 class={`text-xl md:text-2xl font-semibold ${group.year === currentYear ? 'text-emerald-400' : 'text-gray-300'} mb-2`}>{group.year} 年</h2>
                  <div class={`timeline ${group.year === currentYear ? 'timeline-current' : ''}`}>
                    {group.items.map((it: TimelineItem) => {
                      const dt = parseTimelineDate(it.time, group.year);
                      const isRecentSixMonths = !!dt && group.year === currentYear && isWithinLastMonths(dt, 6);
                      return (
                        <div class={`timeline-item ${isRecentSixMonths ? 'is-current-year' : ''}`} data-category={it.category ?? ""} data-tags={(it.tags ?? []).join(",")}>
                          <div class="flex items-start gap-3 text-sm md:text-base">
                            <span class="text-gray-400 w-16 shrink-0">{it.time}</span>
                            <a href={`/blog/detail/?id=${it.blogId}`} class="hover:text-white text-gray-200">{it.title}</a>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          </div>

          <!-- 分类文章列表视图（初始隐藏） -->
          <div id="category-list-view" class="card rounded-2xl shadow-xl bg-white/5 backdrop-blur-md border border-white/5 hidden">
            <div class="card-body">
              <div class="flex items-center justify-between mb-2">
                <h1 class="text-2xl md:text-3xl font-bold"><span id="category-list-title">分类文章</span></h1>
                <div class="flex items-center gap-2">
                  <button id="back-to-timeline" class="btn btn-sm btn-outline">返回时间线</button>
                </div>
              </div>
              <div id="category-list-container" class="grid grid-cols-1 gap-2"></div>
              <div id="category-pager" class="mt-2 flex items-center justify-between">
                <div id="pager-info" class="text-xs text-gray-400">第 1 / 1 页</div>
                <div class="join">
                  <button class="btn btn-xs join-item" data-page-prev>上一页</button>
                  <button class="btn btn-xs join-item" data-page-next>下一页</button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- 右侧：分类 & 热门标签 -->
        <aside class="lg:col-span-1 flex flex-col gap-6">
          <!-- 分类 -->
          <div class="card rounded-2xl shadow-xl bg-white/5 backdrop-blur-md border border-white/5">
            <div class="card-body">
              <h3 class="text-lg md:text-xl font-bold">分类</h3>
              <div class="divider my-2"></div>
              <ul class="space-y-2" id="categoryList">
                {categories.map((c: BlogCategory, idx) => (
                  <li>
                    <a href={c.href ?? "#"} data-category-link={c.name} class="block px-3 py-2 rounded-lg hover:bg-base-300">
                      <div class="flex items-center justify-between">
                        <span class="font-medium text-gray-200" data-category-text>{c.name}</span>
                        <span data-category-icon class="w-10 h-10 rounded-full flex items-center justify-center text-gray-400 bg-base-300">
                          <CategoryIcon name={c.icon} class="w-5 h-5" />
                        </span>
                      </div>
                      {c.name === '时间线' ? (
                        <p class="text-xs text-gray-500 mt-1">{timelineCount}条记录</p>
                      ) : (
                        c.count !== undefined ? (
                          <p class="text-xs text-gray-500 mt-1">{c.count}篇文章</p>
                        ) : null
                      )}
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>

          <!-- 热门标签 -->
          <div class="card rounded-2xl shadow-xl bg-white/5 backdrop-blur-md border border-white/5">
            <div class="card-body">
              <h3 class="text-lg md:text-xl font-bold mb-2">热门标签</h3>
              <div class="flex flex-wrap gap-2" id="tagList">
                {hotTags.map((t) => (
                  <a href="#" data-tag-link={t} class="px-3 py-1 rounded-full bg-base-300 text-gray-200 hover:bg-base-200">{t}</a>
                ))}
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>
    <script is:inline>
      document.addEventListener("DOMContentLoaded", () => {
        try {
          const dataScript = document.getElementById('blog-posts-data');
          if (dataScript) {
            window.__allBlogPosts__ = JSON.parse(dataScript.textContent || '[]');
          } else {
            window.__allBlogPosts__ = [];
          }
        } catch (e) {
          console.error('Failed to parse blog posts data:', e);
          window.__allBlogPosts__ = [];
        }

        // 视图状态
        let activeCategory = null; // 当前选中的分类名称
        let activeTag = null; // 当前选中的标签名称
        let currentPage = 1;
        const pageSize = 10;
        let sortMode = 'latest'; // 'latest' | 'hot'

        const timelineView = document.getElementById('timeline-view');
        const listView = document.getElementById('category-list-view');
        const listTitle = document.getElementById('category-list-title');
        const listContainer = document.getElementById('category-list-container');
        const pager = document.getElementById('category-pager');
        const pagerInfo = document.getElementById('pager-info');
        const backBtn = document.getElementById('back-to-timeline');
        // const sortLatestBtn = document.getElementById('sort-latest');
        // const sortHotBtn = document.getElementById('sort-hot');

        // function updateSortButtons() { ... } - Removed as only one sort mode exists
        
        function parseViews(v) {
          return 0; // Removed usage
        }

        function parseTime(t) {
          const s = String(t || '').trim();
          const ts = Date.parse(s);
          if (!isNaN(ts)) return ts;
          // 兜底：提取数字作为排序依据（如 2024/10/05 -> 20241005）
          const digits = s.replace(/[^0-9]/g, '');
          return digits ? parseInt(digits, 10) : 0;
        }

        function showTimelineView() {
          if (timelineView instanceof HTMLElement) timelineView.classList.remove('hidden');
          if (listView instanceof HTMLElement) listView.classList.add('hidden');
        }
        function showListView() {
          if (timelineView instanceof HTMLElement) timelineView.classList.add('hidden');
          if (listView instanceof HTMLElement) listView.classList.remove('hidden');
        }

        // 当展示时间线视图时，将“时间线”分类高亮为绿色
        function setTimelineActiveCategory() {
          activeCategory = '时间线';
          document.querySelectorAll('[data-category-link]').forEach((el) => {
            const isActive = el.getAttribute('data-category-link') === activeCategory;
            const text = el.querySelector('[data-category-text]');
            if (text) {
              text.classList.toggle('text-emerald-400', !!isActive);
              text.classList.toggle('text-gray-200', !isActive);
            }
            const icon = el.querySelector('[data-category-icon]');
            if (icon) {
              icon.classList.toggle('text-emerald-400', !!isActive);
              icon.classList.toggle('bg-emerald-500/25', !!isActive);
              icon.classList.toggle('text-gray-400', !isActive);
              icon.classList.toggle('bg-base-300', !isActive);
            }
          });
        }

        function normalizeTag(tag) {
          return String(tag || '').trim();
        }

        function getAllArticles() {
          return window.__allBlogPosts__ || [];
        }

        function getFilteredArticles() {
          let filtered = getAllArticles();
          const tag = normalizeTag(activeTag);
          const hasCategory = !!activeCategory && activeCategory !== '时间线';

          // 1. Filter by Category
          if (hasCategory) {
            filtered = filtered.filter((a) => a.category === activeCategory);
          }

          // 2. Filter by Tag
          if (tag) {
            filtered = filtered.filter((a) => (a.tags || []).includes(tag));
          }

          return filtered;
        }

        function renderList() {
          const items = getFilteredArticles();
          // 排序
          const sorted = [...items].sort((a, b) => {
            // latest：时间倒序
            return parseTime(b.time) - parseTime(a.time);
          });
          const total = sorted.length;
          const pages = Math.max(1, Math.ceil(total / pageSize));
          if (currentPage > pages) currentPage = pages;
          const start = (currentPage - 1) * pageSize;
          const slice = sorted.slice(start, start + pageSize);

          if (listTitle) {
            const catText = activeCategory && activeCategory !== '时间线' ? `${activeCategory}` : '';
            const tagText = activeTag ? `${activeTag}` : '';
            const joinText = [catText, tagText].filter(Boolean).join(' · ');
            listTitle.textContent = joinText || '分类文章';
          }

          if (listContainer) {
            const html = slice.map((a) => {
              // 标签渲染：使用更紧凑的样式
              const tagsHtml = Array.isArray(a.tags) && a.tags.length
                ? `<div class="flex flex-wrap gap-2 text-xs">${a.tags.map((t) => `<span class="px-2 py-0.5 rounded bg-base-300/50 text-gray-400 border border-white/5">${t}</span>`).join('')}</div>`
                : '<div></div>';
              
              // 移除大封面占位，改为紧凑的卡片布局
              return `
                <a href="/blog/detail/?id=${a.blogId}" class="group relative flex flex-col p-4 sm:p-5 rounded-xl bg-white/5 border border-white/5 hover:bg-white/10 hover:border-emerald-500/30 transition-all duration-300 w-full">
                  <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                    <span class="flex items-center gap-1.5 font-mono text-emerald-500/80">
                      <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                      ${a.time || ''}
                    </span>
                    ${a.category ? `<span class="px-2 py-0.5 rounded-full bg-base-300 text-gray-500 text-[10px]">${a.category}</span>` : ''}
                  </div>
                  
                  <h3 class="text-base sm:text-lg font-bold text-gray-200 group-hover:text-emerald-400 transition-colors mb-4 line-clamp-2">
                    ${a.title}
                  </h3>
                  
                  <div class="mt-auto flex items-end justify-between gap-4">
                    ${tagsHtml}
                    <span class="text-gray-600 group-hover:text-emerald-400 group-hover:translate-x-1 transition-all duration-300 shrink-0">
                      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                    </span>
                  </div>
                </a>
              `;
            }).join('');
            listContainer.innerHTML = html;
          }

          if (pagerInfo) {
            pagerInfo.textContent = `第 ${currentPage} / ${Math.max(1, pages)} 页`;
          }

          // 控制分页按钮禁用
          if (pager instanceof HTMLElement) {
            const prevBtn = pager.querySelector('[data-page-prev]');
            const nextBtn = pager.querySelector('[data-page-next]');
            if (prevBtn instanceof HTMLElement) prevBtn.toggleAttribute('disabled', currentPage <= 1);
            if (nextBtn instanceof HTMLElement) nextBtn.toggleAttribute('disabled', currentPage >= pages);
          }
        }

        // 分类点击：列表/时间线切换
        document.querySelectorAll('[data-category-link]').forEach((a) => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const name = a.getAttribute('data-category-link');
            const wasSelected = (activeCategory === name);
            activeCategory = wasSelected ? null : name;

            // 更新选中态样式
            document.querySelectorAll('[data-category-link]').forEach((el) => {
              const isActive = el.getAttribute('data-category-link') === activeCategory;
              const text = el.querySelector('[data-category-text]');
              if (text) {
                text.classList.toggle('text-emerald-400', !!isActive);
                text.classList.toggle('text-gray-200', !isActive);
              }
              const icon = el.querySelector('[data-category-icon]');
              if (icon) {
                icon.classList.toggle('text-emerald-400', !!isActive);
                icon.classList.toggle('bg-emerald-500/25', !!isActive);
                icon.classList.toggle('text-gray-400', !isActive);
                icon.classList.toggle('bg-base-300', !isActive);
              }
            });

            // 点击“时间线” -> 回到时间线视图并高亮“时间线”分类，同时取消已选标签
            if (name === '时间线') {
              activeTag = null;
              document.querySelectorAll('[data-tag-link]').forEach((el) => {
                el.classList.remove('bg-emerald-500/25');
                el.classList.remove('text-emerald-400');
                el.classList.add('bg-base-300');
                el.classList.add('text-gray-200');
              });
              showTimelineView();
              setTimelineActiveCategory();
              return;
            }

            // 二次点击同一分类 -> 返回时间线并取消已选标签
            if (wasSelected) {
              activeTag = null;
              document.querySelectorAll('[data-tag-link]').forEach((el) => {
                el.classList.remove('bg-emerald-500/25');
                el.classList.remove('text-emerald-400');
                el.classList.add('bg-base-300');
                el.classList.add('text-gray-200');
              });
              showTimelineView();
              setTimelineActiveCategory();
              return;
            }

            // 进入列表视图（按分类），保留已选择的标签（如果有）
            currentPage = 1;
            renderList();
            showListView();
          });
        });

        // 标签点击：进入列表视图（按标签）
        document.querySelectorAll('[data-tag-link]').forEach((a) => {
          a.addEventListener('click', (e) => {
            e.preventDefault();
            const name = a.getAttribute('data-tag-link');
            const wasSelected = (activeTag === name);
            activeTag = wasSelected ? null : name;

            // 更新选中态样式（选中时文字变绿）
            document.querySelectorAll('[data-tag-link]').forEach((el) => {
              const isActive = el.getAttribute('data-tag-link') === activeTag;
              el.classList.toggle('bg-emerald-500/25', !!isActive);
              el.classList.toggle('bg-base-300', !isActive);
              el.classList.toggle('text-emerald-400', !!isActive);
              el.classList.toggle('text-gray-200', !isActive);
            });

            if (wasSelected) {
              // 标签取消：若仍有分类选中，则显示分类列表；否则回到时间线
              if (activeCategory && activeCategory !== '时间线') {
                currentPage = 1;
                renderList();
                showListView();
              } else {
                showTimelineView();
                setTimelineActiveCategory();
              }
              return;
            }

            // 若当前分类为“时间线”，选择标签时改为列表视图（清空分类）
            if (activeCategory === '时间线') {
              activeCategory = null;
              document.querySelectorAll('[data-category-link]').forEach((el) => {
                const text = el.querySelector('[data-category-text]');
                if (text) {
                  text.classList.remove('text-emerald-400');
                  text.classList.add('text-gray-200');
                }
                const icon = el.querySelector('[data-category-icon]');
                if (icon) {
                  icon.classList.remove('text-emerald-400', 'bg-emerald-500/25');
                  icon.classList.add('text-gray-400', 'bg-base-300');
                }
              });
            }

            currentPage = 1;
            renderList();
            showListView();
          });
        });

        // 排序按钮 (已移除)
        // sortLatestBtn && sortLatestBtn.addEventListener('click', ...);
        // sortHotBtn && sortHotBtn.addEventListener('click', ...);

        // 分页按钮
        if (pager instanceof HTMLElement) {
          const prevBtn = pager.querySelector('[data-page-prev]');
          const nextBtn = pager.querySelector('[data-page-next]');
          prevBtn && prevBtn.addEventListener('click', (e) => {
            e.preventDefault();
            if (currentPage > 1) {
              currentPage -= 1;
              renderList();
            }
          });
          nextBtn && nextBtn.addEventListener('click', (e) => {
            e.preventDefault();
            currentPage += 1;
            renderList();
          });
        }

        // 返回时间线
        backBtn && backBtn.addEventListener('click', (e) => {
          e.preventDefault();
          activeCategory = null;
          activeTag = null;
          currentPage = 1;
          // 清空样式
          document.querySelectorAll('[data-category-link]').forEach((el) => {
            const text = el.querySelector('[data-category-text]');
            if (text) {
              text.classList.remove('text-emerald-400');
              text.classList.add('text-gray-200');
            }
            const icon = el.querySelector('[data-category-icon]');
            if (icon) {
              icon.classList.remove('text-emerald-400', 'bg-emerald-500/25');
              icon.classList.add('text-gray-400', 'bg-base-300');
            }
          });
          document.querySelectorAll('[data-tag-link]').forEach((el) => {
            el.classList.remove('bg-emerald-500/25');
            el.classList.remove('text-emerald-400');
            el.classList.add('bg-base-300');
            el.classList.add('text-gray-200');
          });
          showTimelineView();
          // 时间线视图：高亮“时间线”分类
          setTimelineActiveCategory();
        });

        // 初始：时间线视图，并高亮“时间线”分类
        showTimelineView();
        setTimelineActiveCategory();
        // updateSortButtons(); // Removed
      });
    </script>
    <script defer src="/libs/mouse-click.js"></script>
    <!-- 注入服务端数据 -->
    <script type="application/json" id="blog-posts-data" set:html={JSON.stringify(allBlogPosts)}></script>
  </body>
</html>